<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>User and Group Management &mdash; Nukestar 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Nukestar 0.1 documentation" href="index.html" />
    <link rel="next" title="Base Software" href="software_setup.html" />
    <link rel="prev" title="Configure Head Node" href="head_node.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="software_setup.html" title="Base Software"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="head_node.html" title="Configure Head Node"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Nukestar 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="user-and-group-management">
<h1>User and Group Management<a class="headerlink" href="#user-and-group-management" title="Permalink to this headline">¶</a></h1>
<p>Cluster user permissions, ssh keys, and UID&#8217;s/GID&#8217;s must be managed in a very
organized way to prevent any strange permissions or connections issues down the road.
To facilitate easy user management, Ansible playbooks are provided in the repo.  Specifically,
in the /roles/common directory.  The idea is to ensure UID&#8217;s, groups, and ssh keys are consistant
between the host OS and the chroot environment.</p>
<p>Ansible can be installed by apt-get:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#apt-get update &amp;&amp; apt-get install ansible</span>
</pre></div>
</div>
<p>Ansible&#8217;s only dependency is ssh.</p>
<p>The primary yml file used for user and group management is: <code class="docutils literal"><span class="pre">roles/common/vars/main.yml</span></code>.  This file should be kept up to date
at all times.  If you want to add a user, group, or add a user to a particular group then it is highly recommended to USE THIS FILE to do so.  As a bounous, it is easy to keep track of all the users and groups (rather than relying on unix commands, which could get burdensome if ~30 users with many groups are all floating around) on the system in one tidy file. It may be desirable to create a symlink to this file in an easily accessible path like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">nukecluster</span><span class="o">/</span><span class="n">roles</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="nb">vars</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">nukecluster</span><span class="o">/</span><span class="n">usr_settings</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p>This file contains user and group settings:</p>
<div class="highlight-python"><div class="highlight"><pre>ssh_users:
  - name: wlg333
    groups: users,mcnpx,vera-admin,mcnp6,njoy,serpent,origin,sudo
    shell: /bin/bash
    uid: 1010

  - name: armstru
    groups: users,mcnpx
    shell: /bin/bash
    uid: 1011

  - name: dbz473
    groups: users
    shell: /bin/bash
    uid: 1012

  - name: rf8465
    groups: users,mcnpx,mcnp6,origin,njoy,serpent,sudo
    shell: /bin/bash
    uid: 1013

  - name: admin
    groups: mcnpx,mcnp6,origin,njoy,serpent,sudo
    shell: /bin/bash
    uid: 1014

# List of groups.  Add or remove groups from the cluster here.
cluster_groups:
  - name: vera-admin
    gid:  2101
  - name: mcnpx
    gid:  2102
  - name: mcnp6
    gid:  2103
  - name: origin
    gid:  2104
  - name: njoy
    gid:  2105
  - name: serpent
    gid:  2106
  - name: users
    gid:  2100
  - name: sudo
    gid:  2000

# dummy variable used for temp key storage
keys_dir:  /root/nukecluster/roles/common/files
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This file is syntax sensitive.  Abide by yml syntax and mind whitespace.  Lists are comma seperated, no spaces
indentation must be perfect. spaces only.</p>
</div>
<p>When this user settings file is modified the next step is to run the usermod.yml playbood (idiomatically &#8220;usermod play&#8221;) in the base directory of this repo:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#ansible-playbook usermod.yml</span>
</pre></div>
</div>
<p>By default, the usermod.yml top level script will run all user, group, and ssh commands required.  Note: you must be logged into the root account to run the usermod play.</p>
<div class="section" id="note-on-external-ssh-keys">
<h2>Note on External SSH Keys<a class="headerlink" href="#note-on-external-ssh-keys" title="Permalink to this headline">¶</a></h2>
<p>By default, the usermod play looks for a <code class="docutils literal"><span class="pre">foreign_keys</span></code> file in the <code class="docutils literal"><span class="pre">/home/&lt;user&gt;/.ssh/.</span></code> folder of each user when run.  Keys in this file are appended to the <code class="docutils literal"><span class="pre">authorized_keys</span></code> file for that user.  This is done to try to keep externally generated keys seperate from internally generated keys.</p>
<p>When a new user wants remote access to the cluster. 1) request an rsa public key from him.  2) add that rsa pub key to his <code class="docutils literal"><span class="pre">/home/&lt;his_username&gt;/.ssh/foreign_keys</span></code> file. 3) add his username (and groups, prefered shell &amp; uid) to the users and groups settings file as shown above. 4) Run the usermod play.</p>
</div>
<div class="section" id="enabling-auto-ssh-chroot-on-login">
<h2>Enabling Auto SSH Chroot on login<a class="headerlink" href="#enabling-auto-ssh-chroot-on-login" title="Permalink to this headline">¶</a></h2>
<p>On the base system, edit <code class="docutils literal"><span class="pre">/etc/ssh/sshd_config</span></code>.  At the end of this file, add</p>
<div class="highlight-python"><div class="highlight"><pre>Match group users
    ChrootDirectory /srv/nukeroot
    AllowX11Forwarding yes
</pre></div>
</div>
<p>Restart sshd</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#/etc/init.d/ssh restart</span>
</pre></div>
</div>
<p>When users in the <code class="docutils literal"><span class="pre">users</span></code> group ssh into the cluster, they will imediately be relegated to
the Chroot environment, where all the compute software lives.  Non-admins essentially never see the
host operating system.  It is imparitive that the admin account is not a member of the <code class="docutils literal"><span class="pre">users</span></code> group
so that when the admin remotely logs in, he has access to the base OS AND the chroot.  There is no good
way to break out of the chroot once you are placed inside by sshd.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">User and Group Management</a><ul>
<li><a class="reference internal" href="#note-on-external-ssh-keys">Note on External SSH Keys</a></li>
<li><a class="reference internal" href="#enabling-auto-ssh-chroot-on-login">Enabling Auto SSH Chroot on login</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="head_node.html"
                        title="previous chapter">Configure Head Node</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="software_setup.html"
                        title="next chapter">Base Software</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/user_management.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="software_setup.html" title="Base Software"
             >next</a> |</li>
        <li class="right" >
          <a href="head_node.html" title="Configure Head Node"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Nukestar 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2014, william gurecky.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>